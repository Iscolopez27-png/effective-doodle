<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Siniestralidad por Seguro y Grupo</title>
    
    <!-- Librería XLSX para leer Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Librerías para PDF (jspdf y autotable) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Librería Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Configuración de Colores Personalizados (Pantone) -->
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        pantone: {
                            DEFAULT: '#003DA5', 
                            light: '#3361BA',
                            dark: '#002A70'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Estilos base */
        input[type="file"]::file-selector-button {
            background-color: #003DA5;
            color: white;
            border: 0;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover {
            background-color: #002A70;
        }
        .table-row-odd { background-color: #ffffff; }
        .table-row-even { background-color: #f8fafc; }
        .dark .table-row-odd { background-color: #1f2937; }
        .dark .table-row-even { background-color: #111827; }
        
        /* Estilos para el dropdown multiselect */
        .multiselect-dropdown {
            max-height: 250px;
            overflow-y: auto;
            scrollbar-width: thin;
        }
        .multiselect-dropdown::-webkit-scrollbar {
            width: 6px;
        }
        .multiselect-dropdown::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
    </style>
</head>
<body class="bg-gray-50 dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen font-sans transition-colors duration-300">

    <main class="max-w-7xl mx-auto p-4 sm:p-8">
        
        <!-- Tarjeta Principal -->
        <div class="bg-white dark:bg-gray-800 rounded-xl shadow-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
            
            <!-- Encabezado -->
            <div class="p-6 border-b border-gray-200 dark:border-gray-700 bg-gray-50 dark:bg-gray-800 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                <div>
                    <h1 class="text-2xl sm:text-3xl font-bold text-pantone dark:text-blue-400">
                        Siniestralidad por Seguro y Grupo
                    </h1>
                    <p class="text-sm text-gray-500 mt-1">Procesamiento local y seguro de datos.</p>
                </div>
                <!-- Botonera de Acciones -->
                <div class="flex flex-col sm:flex-row gap-2">
                    <button id="pdfButton" class="hidden inline-flex items-center px-5 py-2.5 bg-red-600 hover:bg-red-700 text-white text-sm font-medium rounded-lg shadow-md transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>
                        Exportar a PDF
                    </button>
                    <button id="exportButton" class="hidden inline-flex items-center px-5 py-2.5 bg-green-600 hover:bg-green-700 text-white text-sm font-medium rounded-lg shadow-md transition-colors">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.5l5.5 5.5V19a2 2 0 01-2 2z"></path></svg>
                        Descargar Excel
                    </button>
                </div>
            </div>

            <div class="p-6 sm:p-8 space-y-6">

                <!-- CONTROLES -->
                <div class="grid grid-cols-1 md:grid-cols-12 gap-6 items-end bg-gray-50 dark:bg-gray-700/50 p-4 rounded-lg border border-gray-200 dark:border-gray-600">
                    
                    <!-- 1. Carga de Archivo (Ancho completo en móvil, 4 columnas en desktop) -->
                    <div class="md:col-span-4">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            1. Archivo de Origen
                        </label>
                        <input type="file" id="fileUpload" accept=".xlsx, .xls" 
                               class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-semibold cursor-pointer focus:outline-none bg-white dark:bg-gray-800 rounded p-1 shadow-sm">
                    </div>

                    <!-- 2. Filtro Ejercicio (Multiselect) -->
                    <div id="exerciseFilterContainer" class="md:col-span-4 hidden relative">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            2. Ejercicio (Año)
                        </label>
                        <button id="exerciseBtn" class="w-full text-left bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-pantone flex justify-between items-center">
                            <span id="exerciseBtnText">Seleccionar...</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <!-- Dropdown Content -->
                        <div id="exerciseDropdown" class="hidden absolute z-30 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-xl multiselect-dropdown">
                            <!-- JS inyectará opciones aquí -->
                        </div>
                    </div>

                    <!-- 3. Filtro Periodo (Multiselect) -->
                    <div id="periodFilterContainer" class="md:col-span-4 hidden relative">
                        <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-2">
                            3. Periodo (Mes)
                        </label>
                        <button id="periodBtn" class="w-full text-left bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg px-4 py-2.5 text-sm font-medium text-gray-700 dark:text-gray-200 shadow-sm focus:outline-none focus:ring-2 focus:ring-pantone flex justify-between items-center">
                            <span id="periodBtnText">Seleccionar...</span>
                            <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </button>
                        <!-- Dropdown Content -->
                        <div id="periodDropdown" class="hidden absolute z-30 w-full mt-1 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg shadow-xl multiselect-dropdown">
                            <!-- JS inyectará opciones aquí -->
                        </div>
                    </div>
                </div>

                <!-- Estado de Carga -->
                <div id="statusArea" class="py-12 text-center hidden">
                    <div id="loadingSpinner" class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-pantone border-r-transparent"></div>
                    <p id="statusText" class="mt-4 text-lg text-gray-600 dark:text-gray-300 font-medium">Procesando...</p>
                </div>

                <!-- CONTENEDOR DE TABLAS -->
                <div id="dashboardContainer" class="space-y-12"></div>

            </div>
        </div>
    </main>

    <!-- Overlay transparente para cerrar dropdowns al hacer click fuera -->
    <div id="dropdownOverlay" class="fixed inset-0 z-20 hidden"></div>

    <script>
        /**
         * CONFIGURACIÓN
         */
        const CONFIG = {
            cols: {
                EJERCICIO: 0,  // A
                FECHA_PAGO: 1, // B
                SEGURO: 3,     // D
                ESTADO: 14,    // O
                MONTO: 28,     // AC
                GRUPO: 35      // AJ
            },
            excluidos: [
                'alta mortalidad cobertura limitada',
                'ataque de depredador cobertura limitada',
                'ganadero por daños climatológicos cobertura limitada'
            ],
            nombreGrupo: 'Seguros Comerciales',
            palette: ['blue', 'emerald', 'violet', 'amber', 'rose', 'cyan', 'indigo', 'teal'],
            rgbMap: {
                'blue': [37, 99, 235],    'emerald': [5, 150, 105], 'violet': [124, 58, 237],
                'amber': [217, 119, 6],   'rose': [225, 29, 72],    'cyan': [8, 145, 178],
                'indigo': [79, 70, 229],  'teal': [13, 148, 136]
            }
        };

        /**
         * ESTADO GLOBAL
         */
        let AppState = {
            rawData: [],
            segurosKeys: [],            
            periods: new Set(),
            exercises: new Set(),      
            consolidationMap: new Map(),
            tablesData: [],
            // Filtros seleccionados (Set de valores)
            selectedExercises: new Set(),
            selectedPeriods: new Set()
        };

        // UI References
        const UI = {
            fileInput: document.getElementById('fileUpload'),
            
            // Containers
            exContainer: document.getElementById('exerciseFilterContainer'),
            perContainer: document.getElementById('periodFilterContainer'),
            
            // Buttons & Dropdowns
            exBtn: document.getElementById('exerciseBtn'),
            exBtnText: document.getElementById('exerciseBtnText'),
            exDropdown: document.getElementById('exerciseDropdown'),
            
            perBtn: document.getElementById('periodBtn'),
            perBtnText: document.getElementById('periodBtnText'),
            perDropdown: document.getElementById('periodDropdown'),
            
            overlay: document.getElementById('dropdownOverlay'),

            exportBtn: document.getElementById('exportButton'),
            pdfBtn: document.getElementById('pdfButton'),
            statusArea: document.getElementById('statusArea'),
            statusText: document.getElementById('statusText'),
            spinner: document.getElementById('loadingSpinner'),
            container: document.getElementById('dashboardContainer')
        };

        // --- LISTENERS INICIALES ---
        UI.fileInput.addEventListener('change', handleFile);
        UI.exportBtn.addEventListener('click', exportAllTables);
        UI.pdfBtn.addEventListener('click', exportToPDF);

        // Lógica de Dropdowns Multiselect
        UI.exBtn.addEventListener('click', () => toggleDropdown('exercise'));
        UI.perBtn.addEventListener('click', () => toggleDropdown('period'));
        UI.overlay.addEventListener('click', closeAllDropdowns);

        function toggleDropdown(type) {
            const dropdown = type === 'exercise' ? UI.exDropdown : UI.perDropdown;
            const isHidden = dropdown.classList.contains('hidden');
            
            closeAllDropdowns(); // Cerrar otros primero
            
            if (isHidden) {
                dropdown.classList.remove('hidden');
                UI.overlay.classList.remove('hidden');
            }
        }

        function closeAllDropdowns() {
            UI.exDropdown.classList.add('hidden');
            UI.perDropdown.classList.add('hidden');
            UI.overlay.classList.add('hidden');
        }

        // --- LOGICA DE NEGOCIO ---

        function normalizeInsuranceName(name) {
            if (!name) return null;
            const cleanName = String(name).trim();
            const lowerName = cleanName.toLowerCase();
            if (CONFIG.excluidos.includes(lowerName)) return cleanName;
            return CONFIG.nombreGrupo;
        }

        function getPeriodKey(excelDate) {
            if (!excelDate) return 'UNKNOWN';
            let date;
            if (typeof excelDate === 'number') {
                date = new Date(Math.round((excelDate - 25569) * 86400 * 1000));
            } else {
                date = new Date(excelDate);
            }
            if (isNaN(date.getTime())) return 'UNKNOWN';
            const year = date.getUTCFullYear();
            const month = String(date.getUTCMonth() + 1).padStart(2, '0');
            return `${year}-${month}`;
        }

        function formatPeriodLabel(periodKey) {
            if (periodKey === 'UNKNOWN') return 'Sin Fecha';
            const [year, month] = periodKey.split('-');
            const date = new Date(parseInt(year), parseInt(month) - 1);
            const monthName = date.toLocaleString('es-MX', { month: 'long' });
            return `${monthName.charAt(0).toUpperCase() + monthName.slice(1)} ${year}`;
        }

        function normalizeGroup(raw) {
            if (raw === null || raw === undefined || String(raw).trim() === '') return 'GRUPO 3';
            const str = String(raw).toUpperCase().trim();
            if (str === '1' || str === 'GRUPO 1' || str === 'G1') return 'GRUPO 1';
            if (str === '2' || str === 'GRUPO 2' || str === 'G2') return 'GRUPO 2';
            return 'GRUPO 3';
        }

        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            resetUI();
            showLoading(true, 'Analizando archivo...');
            const reader = new FileReader();
            reader.onload = (evt) => {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rawJson = XLSX.utils.sheet_to_json(worksheet, { header: 1, range: 1 });
                    processData(rawJson);
                    showLoading(false);
                } catch (err) {
                    console.error("Error local", err);
                    showLoading(true, 'Error crítico al leer el archivo.');
                    UI.spinner.classList.add('hidden');
                }
            };
            reader.readAsArrayBuffer(file);
        }

        function processData(data) {
            AppState.rawData = data;
            AppState.segurosKeys = [];
            AppState.periods.clear();
            AppState.exercises.clear();
            AppState.consolidationMap.clear();
            
            const uniqueKeys = new Set();

            data.forEach(row => {
                const ejercicio = row[CONFIG.cols.EJERCICIO];
                const rawSeguro = row[CONFIG.cols.SEGURO];
                const fechaPago = row[CONFIG.cols.FECHA_PAGO];

                if (!ejercicio || !rawSeguro) return;

                // Guardar Ejercicio
                AppState.exercises.add(String(ejercicio));

                // Guardar Periodo
                const periodKey = getPeriodKey(fechaPago);
                if (periodKey !== 'UNKNOWN') AppState.periods.add(periodKey);

                // Procesar Seguro
                const processedName = normalizeInsuranceName(rawSeguro);
                const uniqueKey = `${processedName} - ${ejercicio}`;
                uniqueKeys.add(uniqueKey);

                // Consolidación
                if (processedName === CONFIG.nombreGrupo) {
                    if (!AppState.consolidationMap.has(uniqueKey)) {
                        AppState.consolidationMap.set(uniqueKey, new Set());
                    }
                    if (rawSeguro && String(rawSeguro).toLowerCase() !== CONFIG.nombreGrupo.toLowerCase()) {
                        AppState.consolidationMap.get(uniqueKey).add(rawSeguro);
                    }
                }
            });

            AppState.segurosKeys = Array.from(uniqueKeys).sort();
            
            // Inicializar filtros con "Todo Seleccionado"
            AppState.selectedExercises = new Set(AppState.exercises);
            AppState.selectedPeriods = new Set(AppState.periods);
            
            buildMultiSelect('exercise');
            buildMultiSelect('period');
            
            renderDashboard();
        }

        // --- CONSTRUCTOR DE DROPDOWNS MULTISELECT ---
        function buildMultiSelect(type) {
            const isExercise = type === 'exercise';
            const container = isExercise ? UI.exContainer : UI.perContainer;
            const dropdown = isExercise ? UI.exDropdown : UI.perDropdown;
            const allItems = Array.from(isExercise ? AppState.exercises : AppState.periods).sort().reverse();
            
            container.classList.remove('hidden');
            dropdown.innerHTML = '';

            // Opción "Seleccionar Todo"
            const allDiv = document.createElement('div');
            allDiv.className = "px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 border-b border-gray-200 dark:border-gray-700 cursor-pointer flex items-center";
            allDiv.innerHTML = `
                <input type="checkbox" checked class="w-4 h-4 text-pantone rounded border-gray-300 focus:ring-pantone cursor-pointer" id="all-${type}">
                <label for="all-${type}" class="ml-2 text-sm font-bold text-gray-700 dark:text-gray-200 cursor-pointer w-full">Seleccionar Todo</label>
            `;
            allDiv.addEventListener('click', (e) => {
                // Prevenir doble disparo si se da click al checkbox directamente
                if(e.target.tagName === 'INPUT') return toggleSelectAll(type, e.target.checked);
                const checkbox = allDiv.querySelector('input');
                checkbox.checked = !checkbox.checked;
                toggleSelectAll(type, checkbox.checked);
            });
            dropdown.appendChild(allDiv);

            // Lista de Opciones
            allItems.forEach(item => {
                const label = isExercise ? item : formatPeriodLabel(item);
                const val = item;
                
                const itemDiv = document.createElement('div');
                itemDiv.className = "px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer flex items-center";
                itemDiv.innerHTML = `
                    <input type="checkbox" checked value="${val}" class="w-4 h-4 text-pantone rounded border-gray-300 focus:ring-pantone cursor-pointer item-check-${type}">
                    <span class="ml-2 text-sm text-gray-700 dark:text-gray-200">${label}</span>
                `;
                
                itemDiv.addEventListener('click', (e) => {
                    if(e.target.tagName === 'INPUT') return updateSelection(type);
                    const checkbox = itemDiv.querySelector('input');
                    checkbox.checked = !checkbox.checked;
                    updateSelection(type);
                });
                dropdown.appendChild(itemDiv);
            });

            updateButtonLabel(type);
        }

        function toggleSelectAll(type, isChecked) {
            const checkboxes = document.querySelectorAll(`.item-check-${type}`);
            checkboxes.forEach(cb => cb.checked = isChecked);
            updateSelection(type);
        }

        function updateSelection(type) {
            const isExercise = type === 'exercise';
            const checkboxes = document.querySelectorAll(`.item-check-${type}`);
            const selectedSet = isExercise ? AppState.selectedExercises : AppState.selectedPeriods;
            
            selectedSet.clear();
            let allChecked = true;

            checkboxes.forEach(cb => {
                if (cb.checked) {
                    selectedSet.add(cb.value);
                } else {
                    allChecked = false;
                }
            });

            // Actualizar estado visual del checkbox "Todos"
            document.getElementById(`all-${type}`).checked = allChecked;
            
            updateButtonLabel(type);
            renderDashboard(); // Re-renderizar automáticamente al cambiar selección
        }

        function updateButtonLabel(type) {
            const isExercise = type === 'exercise';
            const selectedSet = isExercise ? AppState.selectedExercises : AppState.selectedPeriods;
            const totalAvailable = isExercise ? AppState.exercises.size : AppState.periods.size;
            const btnText = isExercise ? UI.exBtnText : UI.perBtnText;

            if (selectedSet.size === 0) {
                btnText.textContent = "Nada seleccionado";
            } else if (selectedSet.size === totalAvailable) {
                btnText.textContent = "Acumulado (Todo)";
            } else {
                btnText.textContent = `${selectedSet.size} seleccionados`;
            }
        }

        // --- RENDERIZADO DEL TABLERO ---
        function renderDashboard() {
            UI.container.innerHTML = '';
            AppState.tablesData = [];
            
            let hasAnyData = false;

            // Filtrar las claves de seguros primero por EJERCICIO seleccionado
            const visibleKeys = AppState.segurosKeys.filter(key => {
                const [_, year] = key.split(' - ');
                return AppState.selectedExercises.has(year);
            });

            visibleKeys.forEach((key, index) => {
                const themeColor = CONFIG.palette[index % CONFIG.palette.length];
                const htmlTable = generateTableForInsurance(key, themeColor);
                if (htmlTable) {
                    hasAnyData = true;
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = htmlTable;
                    UI.container.appendChild(wrapper);
                }
            });

            if (!hasAnyData) {
                UI.container.innerHTML = `<div class="text-center text-gray-500 py-10 border-2 border-dashed border-gray-300 rounded-lg">No hay datos disponibles para la selección actual.</div>`;
                UI.exportBtn.classList.add('hidden');
                UI.pdfBtn.classList.add('hidden');
            } else {
                UI.exportBtn.classList.remove('hidden');
                UI.pdfBtn.classList.remove('hidden');
            }
        }

        function generateTableForInsurance(key, color) {
            const [targetName, targetYear] = key.split(' - ');
            
            const filteredRows = AppState.rawData.filter(row => {
                const rowYear = String(row[CONFIG.cols.EJERCICIO]);
                const rowName = normalizeInsuranceName(row[CONFIG.cols.SEGURO]);
                const rowDate = row[CONFIG.cols.FECHA_PAGO];
                
                // 1. Filtro básico (Nombre y Año coinciden con la clave)
                if (rowYear !== targetYear || rowName !== targetName) return false;

                // 2. Filtro de Periodo (Multiselect)
                const rowPeriod = getPeriodKey(rowDate);
                // Si el periodo de la fila está en el Set de seleccionados, pasa.
                // Nota: 'UNKNOWN' se descarta si no está seleccionado explícitamente (si implementáramos esa opción)
                if (!AppState.selectedPeriods.has(rowPeriod)) return false;

                return true;
            });

            if (filteredRows.length === 0) return null;

            const pivot = new Map();
            const allGroups = new Set();
            
            filteredRows.forEach(row => {
                const estado = row[CONFIG.cols.ESTADO];
                const rawGrupo = row[CONFIG.cols.GRUPO];
                const grupo = normalizeGroup(rawGrupo);
                let monto = parseFloat(row[CONFIG.cols.MONTO]);
                if (isNaN(monto)) monto = 0;
                if (!estado) return;
                allGroups.add(grupo);
                if (!pivot.has(estado)) pivot.set(estado, new Map());
                const stateMap = pivot.get(estado);
                stateMap.set(grupo, (stateMap.get(grupo) || 0) + monto);
            });

            AppState.tablesData.push({
                name: key,
                groups: Array.from(allGroups).sort(),
                states: Array.from(pivot.keys()).sort(),
                pivot: pivot,
                colorName: color
            });

            const sortedGroups = Array.from(allGroups).sort();
            const sortedStates = Array.from(pivot.keys()).sort();
            const colTotals = new Map();
            let grandTotal = 0;
            let noteHtml = '';
            if (AppState.consolidationMap.has(key)) {
                const originals = Array.from(AppState.consolidationMap.get(key)).join(', ');
                if (originals) {
                    noteHtml = `<div class="mb-3 text-sm text-gray-600 dark:text-gray-400 bg-gray-100 dark:bg-gray-700 p-2 rounded border-l-4 border-${color}-400"><strong>Incluye:</strong> ${originals}</div>`;
                }
            }

            let html = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg border border-gray-200 dark:border-gray-700 overflow-hidden transition-all hover:shadow-xl">
                    <div class="p-4 border-b border-gray-200 dark:border-gray-700 bg-${color}-50 dark:bg-gray-800">
                        <h2 class="text-xl font-bold text-${color}-800 dark:text-${color}-300 border-b-4 border-${color}-600 inline-block pb-1">
                            Seguro: ${key}
                        </h2>
                        ${noteHtml}
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-${color}-50 dark:bg-gray-800">
                                <tr>
                                    <th class="sticky left-0 z-20 bg-${color}-50 dark:bg-gray-800 px-6 py-3 text-left text-xs font-bold text-${color}-800 dark:text-${color}-200 uppercase tracking-wider border-b-2 border-${color}-600">Estado</th>
                                    ${sortedGroups.map(g => `<th class="px-6 py-3 text-right text-xs font-bold text-${color}-800 dark:text-${color}-200 uppercase tracking-wider border-b-2 border-${color}-600">${g}</th>`).join('')}
                                    <th class="px-6 py-3 text-right text-xs font-extrabold text-${color}-900 dark:text-white uppercase tracking-wider border-b-2 border-${color}-600">Total</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            sortedStates.forEach((estado, idx) => {
                const rowClass = idx % 2 === 0 ? 'table-row-even' : 'table-row-odd';
                const stateData = pivot.get(estado);
                let rowTotal = 0;
                html += `<tr class="${rowClass} hover:bg-${color}-50 dark:hover:bg-gray-700 transition-colors">`;
                html += `<td class="sticky left-0 z-10 ${rowClass} px-6 py-3 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white border-r border-gray-200 dark:border-gray-700 shadow-sm">${estado}</td>`;
                sortedGroups.forEach(grupo => {
                    const val = stateData.get(grupo) || 0;
                    rowTotal += val;
                    colTotals.set(grupo, (colTotals.get(grupo) || 0) + val);
                    const valStr = val === 0 ? '-' : formatCurrency(val);
                    html += `<td class="px-6 py-3 whitespace-nowrap text-sm text-gray-600 dark:text-gray-300 text-right">${valStr}</td>`;
                });
                grandTotal += rowTotal;
                html += `<td class="px-6 py-3 whitespace-nowrap text-sm font-bold text-gray-900 dark:text-white text-right border-l border-gray-200 dark:border-gray-700">${formatCurrency(rowTotal)}</td></tr>`;
            });

            html += `
                <tr class="bg-${color}-100 dark:bg-${color}-900/30 font-bold border-t-2 border-${color}-600">
                    <td class="sticky left-0 z-10 bg-${color}-200 dark:bg-gray-800 px-6 py-3 whitespace-nowrap text-sm uppercase text-${color}-900 dark:text-${color}-300 border-r border-${color}-300">Gran Total</td>
                    ${sortedGroups.map(g => `<td class="px-6 py-3 whitespace-nowrap text-sm text-right text-${color}-900 dark:text-${color}-300">${formatCurrency(colTotals.get(g) || 0)}</td>`).join('')}
                    <td class="px-6 py-3 whitespace-nowrap text-sm text-right text-${color}-900 dark:text-${color}-300 border-l border-${color}-300">${formatCurrency(grandTotal)}</td>
                </tr>
            `;
            html += `</tbody></table></div></div>`;
            return html;
        }

        // --- UTILIDADES ---
        function formatCurrency(num) {
            return num.toLocaleString('es-MX', { style: 'currency', currency: 'MXN', minimumFractionDigits: 2 });
        }

        function resetUI() {
            UI.exContainer.classList.add('hidden');
            UI.perContainer.classList.add('hidden');
            UI.exportBtn.classList.add('hidden');
            UI.pdfBtn.classList.add('hidden');
            UI.container.innerHTML = '';
            UI.statusArea.classList.add('hidden');
        }

        function showLoading(show, text) {
            if (show) {
                UI.statusText.textContent = text || 'Cargando...';
                UI.statusArea.classList.remove('hidden');
                UI.spinner.classList.remove('hidden');
            } else {
                UI.statusArea.classList.add('hidden');
            }
        }

        // --- EXPORTACIONES ---

        function exportAllTables() {
            if (AppState.tablesData.length === 0) return;
            const wb = XLSX.utils.book_new();
            
            // Etiqueta para el nombre de archivo Excel
            let label = "Reporte";
            if (AppState.selectedPeriods.size === AppState.periods.size) {
                label = "Acumulado_Total";
            } else {
                // Si es selección personalizada, usamos "Seleccion"
                label = "Seleccion_Personalizada";
            }

            AppState.tablesData.forEach(tableInfo => {
                const wsData = [];
                wsData.push([`Reporte: ${tableInfo.name}`]);
                wsData.push([]); 
                const headers = ["Estado", ...tableInfo.groups, "Total"];
                wsData.push(headers);
                let grandTotal = 0;
                const colTotals = new Array(tableInfo.groups.length).fill(0);
                tableInfo.states.forEach(estado => {
                    const row = [estado];
                    let rowTotal = 0;
                    const stateMap = tableInfo.pivot.get(estado);
                    tableInfo.groups.forEach((grp, idx) => {
                        const val = stateMap.get(grp) || 0;
                        row.push(val);
                        rowTotal += val;
                        colTotals[idx] += val;
                    });
                    row.push(rowTotal);
                    grandTotal += rowTotal;
                    wsData.push(row);
                });
                const totalRow = ["GRAN TOTAL", ...colTotals, grandTotal];
                wsData.push(totalRow);
                const ws = XLSX.utils.aoa_to_sheet(wsData);
                const range = XLSX.utils.decode_range(ws['!ref']);
                const colWidths = headers.map(h => ({ wch: h.length + 5 }));
                for (let R = range.s.r; R <= range.e.r; ++R) {
                    for (let C = range.s.c; C <= range.e.c; ++C) {
                        const cellAddress = XLSX.utils.encode_cell({r: R, c: C});
                        const cell = ws[cellAddress];
                        if (!cell) continue;
                        if (cell.t === 'n') {
                            cell.z = '"$"#,##0.00';
                        }
                        const cellLength = String(cell.v).length + 2;
                        if (colWidths[C] && cellLength > colWidths[C].wch) {
                            colWidths[C].wch = cellLength;
                        }
                    }
                }
                ws['!cols'] = colWidths;
                let sheetName = tableInfo.name.replace(/[:\/\\?*\[\]]/g, "").substring(0, 30);
                if (wb.SheetNames.includes(sheetName)) {
                    sheetName = sheetName.substring(0, 27) + Math.floor(Math.random() * 99);
                }
                XLSX.utils.book_append_sheet(wb, ws, sheetName);
            });
            XLSX.writeFile(wb, `Reporte_Siniestralidad_${label}.xlsx`);
        }

        async function exportToPDF() {
            if (AppState.tablesData.length === 0) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4'); 
            const pageWidth = doc.internal.pageSize.width;
            const pageHeight = doc.internal.pageSize.height;
            const margin = 14;
            const bottomMargin = 14;
            
            // --- NUEVA LÓGICA DE ETIQUETA ---
            let periodLabel = "";
            if (AppState.selectedPeriods.size === AppState.periods.size) {
                periodLabel = "Acumulado Total";
            } else {
                // Ordenar periodos seleccionados cronológicamente
                const sortedSelected = Array.from(AppState.selectedPeriods).sort();
                // Formatear cada uno a "Mes Año" y unir con comas
                const formattedLabels = sortedSelected.map(key => formatPeriodLabel(key));
                periodLabel = formattedLabels.join(", ");
            }

            doc.setFontSize(16);
            doc.setTextColor(0, 61, 165); 
            doc.text("Reporte de Siniestralidad por Seguro y Grupo", pageWidth / 2, 15, { align: 'center' });
            
            doc.setFontSize(11);
            doc.setTextColor(100);
            
            // Usar splitTextToSize para que el texto de periodos no se salga de la hoja si es muy largo
            const textStr = `Periodo: ${periodLabel}`;
            const splitTitle = doc.splitTextToSize(textStr, pageWidth - (margin * 2));
            doc.text(splitTitle, pageWidth / 2, 22, { align: 'center' });

            // Ajustar la posición Y inicial dependiendo de cuántas líneas ocupó el título
            let finalY = 22 + (splitTitle.length * 5) + 5; 
            if (finalY < 30) finalY = 30; // Mínimo margen de seguridad

            for (let i = 0; i < AppState.tablesData.length; i++) {
                const tableInfo = AppState.tablesData[i];
                let estimatedBlockHeight = 0;
                estimatedBlockHeight += 8; 
                let noteLines = [];
                if (AppState.consolidationMap.has(tableInfo.name)) {
                    const originals = Array.from(AppState.consolidationMap.get(tableInfo.name)).join(', ');
                    if (originals) {
                        doc.setFontSize(9);
                        noteLines = doc.splitTextToSize(`Incluye: ${originals}`, pageWidth - (margin * 2));
                        estimatedBlockHeight += (noteLines.length * 4) + 2; 
                    }
                }
                const rowCount = tableInfo.states.length + 1; 
                const totalRows = rowCount + 1; 
                const tableHeight = totalRows * 7.5; 
                estimatedBlockHeight += tableHeight;
                const spaceLeft = pageHeight - finalY - bottomMargin;

                if (estimatedBlockHeight > spaceLeft && finalY > 30) {
                    doc.addPage();
                    doc.setFontSize(10);
                    doc.setTextColor(150);
                    doc.text("Reporte de Siniestralidad (Continuación)", pageWidth / 2, 10, { align: 'center' });
                    finalY = 20; 
                }

                const rgbColor = CONFIG.rgbMap[tableInfo.colorName] || [0, 61, 165];
                doc.setFontSize(12);
                doc.setTextColor(...rgbColor);
                doc.text(`Seguro: ${tableInfo.name}`, margin, finalY);
                finalY += 6;

                if (noteLines.length > 0) {
                    doc.setFontSize(9);
                    doc.setTextColor(80);
                    doc.text(noteLines, margin, finalY);
                    finalY += (noteLines.length * 4) + 2;
                }

                const headers = [["Estado", ...tableInfo.groups, "Total"]];
                const body = [];
                let grandTotal = 0;
                const colTotals = new Array(tableInfo.groups.length).fill(0);

                tableInfo.states.forEach(estado => {
                    const row = [estado];
                    let rowTotal = 0;
                    const stateMap = tableInfo.pivot.get(estado);
                    tableInfo.groups.forEach((grp, idx) => {
                        const val = stateMap.get(grp) || 0;
                        row.push(formatCurrency(val));
                        rowTotal += val;
                        colTotals[idx] += val;
                    });
                    row.push(formatCurrency(rowTotal));
                    grandTotal += rowTotal;
                    body.push(row);
                });

                const totalRow = ["GRAN TOTAL", ...colTotals.map(v => formatCurrency(v)), formatCurrency(grandTotal)];
                body.push(totalRow);

                doc.autoTable({
                    startY: finalY,
                    head: headers,
                    body: body,
                    theme: 'grid',
                    headStyles: { 
                        fillColor: rgbColor,
                        halign: 'center', 
                        fontStyle: 'bold'
                    },
                    columnStyles: {
                        0: { halign: 'left', fontStyle: 'bold', minCellWidth: 40 }, 
                    },
                    styles: {
                        fontSize: 10, 
                        halign: 'right', 
                        cellPadding: 2,
                        overflow: 'linebreak'
                    },
                    didParseCell: function(data) {
                        if (data.section === 'body' && data.column.index === 0) {
                            data.cell.styles.halign = 'left';
                        }
                        if (data.section === 'body' && data.row.index === body.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [240, 240, 240];
                        }
                    },
                    margin: { top: 20, bottom: 14, left: margin, right: margin } 
                });

                finalY = doc.lastAutoTable.finalY + 15;
            }

            // Nombre de archivo seguro
            const safeLabel = periodLabel.replace(/[, ]+/g, "_").substring(0, 50);
            doc.save(`Reporte_Siniestralidad_${safeLabel}.pdf`);
        }

    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Bienes Patrimoniales</title>
    
    <!-- Cargar Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Cargar React y ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Cargar Babel para interpretar JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Estilos adicionales para scrollbars y animaciones -->
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fadeIn {
            animation: fadeIn 0.2s ease-out forwards;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // --- COMPONENTES DE ICONOS (SVG Inline para reemplazar lucide-react) ---
        const Leaf = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.18 2 8 0 5.5-4.78 10-10 10Z"/><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"/></svg>
        );
        const Upload = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></svg>
        );
        const FileText = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></svg>
        );
        const Filter = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"/></svg>
        );
        const FileDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="M12 18v-6"/><path d="m9 15 3 3 3-3"/></svg>
        );
        const Calculator = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>
        );
        const DollarSign = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" x2="12" y1="2" y2="22"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
        );
        const Hash = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="4" x2="20" y1="9" y2="9"/><line x1="4" x2="20" y1="15" y2="15"/><line x1="10" x2="8" y1="3" y2="21"/><line x1="16" x2="14" y1="3" y2="21"/></svg>
        );
        const AlertCircle = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></svg>
        );
        const Calendar = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>
        );
        const MapPin = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></svg>
        );
        const ChevronDown = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m6 9 6 6 6-6"/></svg>
        );
        const ChevronRight = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m9 18 6-6-6-6"/></svg>
        );
        const CheckSquare = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="9 11 12 14 22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
        );
        const Square = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/></svg>
        );
        const MinusSquare = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect width="18" height="18" x="3" y="3" rx="2"/><path d="M8 12h8"/></svg>
        );
        const Loader2 = ({ className }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
        );

        // --- APLICACIÓN PRINCIPAL ---

        const App = () => {
            const [data, setData] = useState([]);
            const [fileName, setFileName] = useState('');
            const [error, setError] = useState('');
            const [isExcelReady, setIsExcelReady] = useState(false);
            const [isPdfReady, setIsPdfReady] = useState(false);
            const [isLoading, setIsLoading] = useState(false);
            
            // Filtros seleccionados
            const [selectedEjercicios, setSelectedEjercicios] = useState(new Set());
            const [selectedFechas, setSelectedFechas] = useState(new Set());
            const [selectedEstados, setSelectedEstados] = useState(new Set()); 
            
            // Estados visuales para los acordeones de filtros
            const [openFilters, setOpenFilters] = useState({
                ejercicio: true,
                estado: true,
                fecha: true
            });
            const [expandedYears, setExpandedYears] = useState(new Set()); 

            // Texto personalizado para el reporte
            const [customHeaderText, setCustomHeaderText] = useState('');

            // Cargar librerías externas (XLSX y jsPDF)
            useEffect(() => {
                const loadScript = (src) => {
                return new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = src;
                    script.async = true;
                    script.onload = resolve;
                    script.onerror = reject;
                    document.body.appendChild(script);
                });
                };

                // Cargar XLSX
                if (!window.XLSX) {
                loadScript("https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js")
                    .then(() => setIsExcelReady(true))
                    .catch(e => console.error("Error cargando XLSX", e));
                } else {
                setIsExcelReady(true);
                }

                // Cargar jsPDF y AutoTable
                if (!window.jspdf) {
                loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js")
                    .then(() => {
                    return loadScript("https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js");
                    })
                    .then(() => setIsPdfReady(true))
                    .catch(e => console.error("Error cargando jsPDF", e));
                } else {
                setIsPdfReady(true);
                }
            }, []);

            // Función para formatear fechas
            const formatDate = (val) => {
                if (!val) return 'Sin Fecha';
                if (typeof val === 'number' && val > 20000) {
                const date = new Date(Math.round((val - 25569) * 86400 * 1000));
                const userTimezoneOffset = date.getTimezoneOffset() * 60000;
                const adjustedDate = new Date(date.getTime() + userTimezoneOffset);
                return adjustedDate.toLocaleDateString('es-MX');
                }
                const dateObj = new Date(val);
                if (!isNaN(dateObj.getTime())) {
                const splitDate = val.toString().split(/[-/]/);
                if (splitDate.length === 3) return dateObj.toLocaleDateString('es-MX'); 
                return dateObj.toLocaleDateString('es-MX');
                }
                return val; 
            };

            const parseCSV = (text) => {
                const lines = text.split(/\r?\n/);
                if (lines.length < 2) return [];

                const splitRegex = /,(?=(?:(?:[^"]*"){2})*[^"]*$)/;
                const result = [];

                for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                const values = line.split(splitRegex).map(val => {
                    return val.trim().replace(/^"|"$/g, '').replace(/""/g, '"');
                });
                result.push(values);
                }
                return result;
            };

            const processDataArray = (rawData) => {
                if (!rawData || rawData.length < 2) return [];

                return rawData.slice(1).map((row, index) => {
                    const ejercicio = row[0] || 'Desconocido'; // Col A
                    const rawFechaPago = row[1];  // Columna B 
                    const estado = row[10];       // Columna K 
                    const rawUnidades = row[33];  // Columna AH 
                    const rawMonto = row[35];     // Columna AJ 
                    
                    const fechaPago = formatDate(rawFechaPago);
                    const unidades = parseFloat((rawUnidades || '0').toString().replace(/[$,]/g, '')) || 0;
                    const monto = parseFloat((rawMonto || '0').toString().replace(/[$,]/g, '')) || 0;
                    
                    const tipoSeguro = 'Daños a Bienes Patrimoniales;

                    return {
                        id: index,
                        ejercicio: ejercicio ? ejercicio.toString() : 'ND',
                        fechaPago,
                        estado: estado ? estado.toString().toUpperCase().trim() : 'ND',
                        tipoSeguro,
                        unidades,
                        monto
                    };
                }).filter(item => item.monto > 0 || item.unidades > 0);
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                setError('');
                
                if (!file) return;
                setFileName(file.name);
                setIsLoading(true); // Activar carga

                setTimeout(() => {
                    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');

                    if (isExcel) {
                        if (!isExcelReady) {
                            setError("El lector de Excel aún se está cargando. Por favor espera unos segundos e intenta de nuevo.");
                            setIsLoading(false);
                            return;
                        }
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const data = new Uint8Array(e.target.result);
                                const workbook = window.XLSX.read(data, { type: 'array' });
                                const firstSheetName = workbook.SheetNames[0];
                                const worksheet = workbook.Sheets[firstSheetName];
                                const jsonData = window.XLSX.utils.sheet_to_json(worksheet, { header: 1, raw: true }); 
                                
                                const cleanData = processDataArray(jsonData);
                                setData(cleanData);
                                setSelectedEjercicios(new Set(cleanData.map(d => d.ejercicio)));
                                setSelectedFechas(new Set(cleanData.map(d => d.fechaPago)));
                                setSelectedEstados(new Set(cleanData.map(d => d.estado)));
                            } catch (err) {
                                console.error(err);
                                setError("Error al leer el archivo Excel. Asegúrate de que no esté corrupto.");
                            } finally {
                                setIsLoading(false);
                            }
                        };
                        reader.readAsArrayBuffer(file);
                    } else {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            try {
                                const text = e.target.result;
                                const parsedData = parseCSV(text);
                                if (parsedData.length === 0) {
                                    setError('El archivo parece estar vacío.');
                                    return;
                                }
                                const cleanData = processDataArray(parsedData);
                                setData(cleanData);
                                setSelectedEjercicios(new Set(cleanData.map(d => d.ejercicio)));
                                setSelectedFechas(new Set(cleanData.map(d => d.fechaPago)));
                                setSelectedEstados(new Set(cleanData.map(d => d.estado)));
                            } catch (err) {
                                console.error(err);
                                setError('Error al procesar el archivo CSV.');
                            } finally {
                                setIsLoading(false);
                            }
                        };
                        reader.readAsText(file);
                    }
                }, 100);
            };

            // --- OPCIONES ÚNICAS Y AGRUPACIÓN DE FECHAS ---
            const opcionesEjercicios = useMemo(() => [...new Set(data.map(item => item.ejercicio))].sort(), [data]);
            const opcionesEstados = useMemo(() => [...new Set(data.map(item => item.estado))].sort(), [data]);
            
            // Agrupación de Fechas por Año
            const fechasJerarquia = useMemo(() => {
                const fechasUnicas = [...new Set(data.map(item => item.fechaPago))];
                const grupos = {};

                fechasUnicas.forEach(fecha => {
                    const partes = fecha.split('/');
                    const anio = partes.length === 3 ? partes[2] : 'Otros';
                    
                    if (!grupos[anio]) grupos[anio] = [];
                    grupos[anio].push(fecha);
                });

                Object.keys(grupos).forEach(anio => {
                    grupos[anio].sort((a, b) => {
                        const partsA = a.split('/');
                        const partsB = b.split('/');
                        if(partsA.length === 3 && partsB.length === 3) {
                            const dateA = new Date(partsA[2], partsA[1]-1, partsA[0]);
                            const dateB = new Date(partsB[2], partsB[1]-1, partsB[0]);
                            return dateB - dateA; 
                        }
                        return 0;
                    });
                });

                return grupos;
            }, [data]);

            const aniosOrdenados = useMemo(() => Object.keys(fechasJerarquia).sort().reverse(), [fechasJerarquia]);
            const todasLasFechasFlat = useMemo(() => [...new Set(data.map(d => d.fechaPago))], [data]);

            // --- LÓGICA DE FILTRADO ---
            const reporteAgrupado = useMemo(() => {
                if (data.length === 0) return [];

                const filtered = data.filter(item => 
                (selectedEjercicios.size === 0 || selectedEjercicios.has(item.ejercicio)) &&
                (selectedFechas.size === 0 || selectedFechas.has(item.fechaPago)) &&
                (selectedEstados.size === 0 || selectedEstados.has(item.estado))
                );

                const agrupado = filtered.reduce((acc, curr) => {
                const seguro = curr.tipoSeguro;
                if (!acc[seguro]) {
                    acc[seguro] = {
                    nombre: seguro,
                    conteo: 0,
                    totalUnidades: 0,
                    totalMonto: 0
                    };
                }
                acc[seguro].conteo += 1;
                acc[seguro].totalUnidades += curr.unidades;
                acc[seguro].totalMonto += curr.monto;
                return acc;
                }, {});

                return Object.values(agrupado).sort((a, b) => b.totalMonto - a.totalMonto);
            }, [data, selectedEjercicios, selectedFechas, selectedEstados]);

            const totales = useMemo(() => {
                return reporteAgrupado.reduce((acc, item) => ({
                conteo: acc.conteo + item.conteo,
                unidades: acc.unidades + item.totalUnidades,
                monto: acc.monto + item.totalMonto
                }), { conteo: 0, unidades: 0, monto: 0 });
            }, [reporteAgrupado]);

            // --- HELPERS UI ---
            const toggleFilter = (set, value) => {
                const newSet = new Set(set);
                if (newSet.has(value)) newSet.delete(value);
                else newSet.add(value);
                return newSet;
            };

            const toggleAll = (opciones, setActual, setFn) => {
                if (setActual.size === opciones.length) {
                setFn(new Set());
                } else {
                setFn(new Set(opciones));
                }
            };

            const toggleYearSelection = (anio) => {
                const fechasDelAnio = fechasJerarquia[anio];
                const todasSeleccionadas = fechasDelAnio.every(f => selectedFechas.has(f));
                
                const newSet = new Set(selectedFechas);
                if (todasSeleccionadas) {
                    fechasDelAnio.forEach(f => newSet.delete(f));
                } else {
                    fechasDelAnio.forEach(f => newSet.add(f));
                }
                setSelectedFechas(newSet);
            };

            const getYearCheckboxState = (anio) => {
                const fechasDelAnio = fechasJerarquia[anio];
                if (!fechasDelAnio) return 'unchecked';
                const seleccionadas = fechasDelAnio.filter(f => selectedFechas.has(f));
                
                if (seleccionadas.length === 0) return 'unchecked';
                if (seleccionadas.length === fechasDelAnio.length) return 'checked';
                return 'indeterminate';
            };

            const toggleSection = (key) => {
                setOpenFilters(prev => ({ ...prev, [key]: !prev[key] }));
            };

            const toggleYearExpand = (anio) => {
                const newSet = new Set(expandedYears);
                if (newSet.has(anio)) newSet.delete(anio);
                else newSet.add(anio);
                setExpandedYears(newSet);
            };

            const formatCurrency = (val) => {
                return new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'MXN' }).format(val);
            };

            // --- GENERACIÓN DE PDF PROFESIONAL ---
            const generatePDF = () => {
                if (!window.jspdf) {
                alert("La librería PDF aún se está cargando, intenta en unos segundos.");
                return;
                }

                const doc = new window.jspdf.jsPDF();
                const pageWidth = doc.internal.pageSize.width;
                
                const CORP_BLUE_DARK = [30, 58, 138];
                const CORP_BLUE_MED = [37, 99, 235];
                const CORP_GRAY_TEXT = [55, 65, 81];
                const LIGHT_BG = [239, 246, 255];

                // Lógica mejorada para el título de estados
                let estadoTitulo = "TODOS LOS ESTADOS";
                if (selectedEstados.size === 1) {
                    estadoTitulo = Array.from(selectedEstados)[0];
                } else if (selectedEstados.size > 1 && selectedEstados.size < opcionesEstados.length) {
                    estadoTitulo = Array.from(selectedEstados).sort().join(", ");
                }

                doc.setFillColor(...CORP_BLUE_DARK);
                doc.rect(0, 0, pageWidth, 45, 'F');

                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont("helvetica", "bold");
                doc.text("REPORTE DE SINIESTRALIDAD", 14, 18);

                doc.setFontSize(12);
                doc.setFont("helvetica", "bold");
                doc.text("BIENES PATRIMONIALES", 14, 26);

                doc.setFontSize(11);
                doc.setFont("helvetica", "normal");
                
                const maxStateWidth = pageWidth - 90; 
                const estadoText = `ESTADO: ${estadoTitulo}`;
                const splitEstado = doc.splitTextToSize(estadoText, maxStateWidth);
                
                doc.text(splitEstado, 14, 34);

                doc.setFontSize(9);
                const today = new Date().toLocaleDateString('es-MX', { year: 'numeric', month: 'long', day: 'numeric' });
                doc.text(`Generado: ${today}`, pageWidth - 14, 18, { align: 'right' });
                doc.text(`Análisis Pecuario`, pageWidth - 14, 26, { align: 'right' });

                let currentY = 55;

                if (customHeaderText) {
                    doc.setTextColor(...CORP_GRAY_TEXT);
                    doc.setFontSize(10);
                    doc.setFont("helvetica", "italic");
                    const splitText = doc.splitTextToSize(customHeaderText, pageWidth - 28);
                    doc.text(splitText, 14, currentY);
                    currentY += (splitText.length * 5) + 10;
                }

                doc.setFillColor(...LIGHT_BG); 
                doc.setDrawColor(191, 219, 254);
                doc.roundedRect(14, currentY, pageWidth - 28, 30, 1, 1, 'FD');

                doc.setTextColor(...CORP_BLUE_DARK);
                doc.setFontSize(8);
                doc.setFont("helvetica", "bold");
                doc.text("RESUMEN EJECUTIVO", 18, currentY + 8);

                const boxWidth = pageWidth - 28;
                const thirdWidth = boxWidth / 3;
                const kpiCenterY = currentY + 18; 

                const drawCenteredKPI = (label, value, sectionIndex, valueColor = [0,0,0]) => {
                    const centerX = 14 + (thirdWidth * sectionIndex) + (thirdWidth / 2);
                    
                    doc.setFontSize(9);
                    doc.setTextColor(...CORP_GRAY_TEXT);
                    doc.setFont("helvetica", "normal");
                    doc.text(label, centerX, kpiCenterY - 2, { align: 'center' });

                    doc.setFontSize(12);
                    doc.setTextColor(...valueColor);
                    doc.setFont("helvetica", "bold");
                    doc.text(value, centerX, kpiCenterY + 5, { align: 'center' });
                };

                drawCenteredKPI("EVENTOS REGISTRADOS", totales.conteo.toString(), 0, CORP_BLUE_DARK);
                
                doc.setDrawColor(219, 234, 254);
                doc.line(14 + thirdWidth, currentY + 6, 14 + thirdWidth, currentY + 24);
                doc.line(14 + (thirdWidth * 2), currentY + 6, 14 + (thirdWidth * 2), currentY + 24);

                drawCenteredKPI("TOTAL UNIDADES", new Intl.NumberFormat('es-MX').format(totales.unidades), 1, CORP_BLUE_DARK);
                drawCenteredKPI("TOTAL INDEMNIZADO", formatCurrency(totales.monto), 2, CORP_BLUE_MED);

                currentY += 40; 

                const tableColumn = ["TIPO DE SEGURO", "FRECUENCIA", "UNIDADES", "MONTO INDEMNIZADO"];
                const tableRows = [];

                reporteAgrupado.forEach(row => {
                    const rowData = [
                        row.nombre,
                        row.conteo,
                        new Intl.NumberFormat('es-MX').format(row.totalUnidades),
                        formatCurrency(row.totalMonto)
                    ];
                    tableRows.push(rowData);
                });

                tableRows.push([
                    "TOTAL GENERAL",
                    totales.conteo,
                    new Intl.NumberFormat('es-MX').format(totales.unidades),
                    formatCurrency(totales.monto)
                ]);

                doc.autoTable({
                    head: [tableColumn],
                    body: tableRows,
                    startY: currentY,
                    theme: 'grid', 
                    styles: {
                        fontSize: 9,
                        cellPadding: 4,
                        valign: 'middle',
                        lineColor: [229, 231, 235],
                        lineWidth: 0.1,
                        textColor: CORP_GRAY_TEXT
                    },
                    headStyles: { 
                        fillColor: CORP_BLUE_DARK,
                        textColor: 255,
                        fontStyle: 'bold',
                        halign: 'center',
                        lineWidth: 0
                    },
                    columnStyles: {
                        0: { cellWidth: 'auto', halign: 'left' }, 
                        1: { cellWidth: 30, halign: 'center' },   
                        2: { cellWidth: 40, halign: 'right' },    
                        3: { cellWidth: 50, halign: 'right' }     
                    },
                    footStyles: {
                        fillColor: LIGHT_BG,
                        textColor: CORP_BLUE_DARK,
                        fontStyle: 'bold'
                    },
                    didParseCell: function (data) {
                        if (data.row.index === tableRows.length - 1) {
                            data.cell.styles.fontStyle = 'bold';
                            data.cell.styles.fillColor = [239, 246, 255];
                            data.cell.styles.textColor = CORP_BLUE_DARK;
                            if (data.column.index === 3) {
                                data.cell.styles.textColor = CORP_BLUE_MED;
                            }
                        }
                    }
                });

                const pageCount = doc.internal.getNumberOfPages();
                doc.setTextColor(156, 163, 175);
                doc.setFontSize(8);
                for(var i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.line(14, doc.internal.pageSize.height - 15, pageWidth - 14, doc.internal.pageSize.height - 15); 
                    doc.text(`Página ${i} de ${pageCount}`, pageWidth - 14, doc.internal.pageSize.height - 10, {align: 'right'});
                }

                doc.save(`Reporte_Patrimonial_${estadoTitulo.replace(/[^a-zA-Z0-9 ]/g, '').replace(/\s+/g, '_').substring(0, 50)}.pdf`);
            };

            const CheckIcon = ({ state }) => {
                if (state === 'checked') return <CheckSquare className="w-4 h-4 text-blue-600" />;
                if (state === 'indeterminate') return <MinusSquare className="w-4 h-4 text-blue-600" />;
                return <Square className="w-4 h-4 text-gray-300" />;
            };

            return (
                <div className="min-h-screen bg-gray-50 p-4 font-sans text-gray-800">
                {/* Header */}
                <div className="max-w-7xl mx-auto mb-6 bg-white p-6 rounded-lg shadow-sm border-b border-gray-200">
                    <h1 className="text-2xl font-bold text-blue-900 flex items-center gap-2">
                    <Leaf className="w-8 h-8 text-blue-700" />
                    Reporte de Bienes Patrimoniales
                    </h1>
                    <p className="text-gray-500 mt-1 text-sm">
                    Análisis financiero y estadístico. Versión Ejecutiva.
                    </p>
                </div>

                {/* Main Content */}
                <div className="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-4 gap-6">
                    
                    {/* Sidebar */}
                    <div className="lg:col-span-1 space-y-4">
                    
                    {/* Upload */}
                    <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                        <label className="block text-xs font-bold text-blue-900 mb-2 uppercase tracking-wide">Cargar Datos</label>
                        <div className={`relative border-2 border-dashed rounded-lg p-4 flex flex-col items-center justify-center transition-colors ${isLoading ? 'border-blue-200 bg-blue-50 cursor-wait' : (isExcelReady ? 'border-blue-300 hover:bg-blue-50 cursor-pointer' : 'border-gray-300 bg-gray-50 cursor-not-allowed')}`}>
                        
                        <input 
                            type="file" 
                            accept=".csv,.txt,.xlsx,.xls" 
                            onChange={handleFileUpload} 
                            className="absolute inset-0 w-full h-full opacity-0 cursor-pointer disabled:cursor-wait"
                            disabled={!isExcelReady || isLoading}
                        />
                        
                        {isLoading ? (
                            <>
                                <Loader2 className="w-8 h-8 mb-2 text-blue-600 animate-spin" />
                                <span className="text-xs font-bold text-blue-700 animate-pulse">Procesando archivo...</span>
                            </>
                        ) : (
                            <>
                                <Upload className={`w-6 h-6 mb-1 ${isExcelReady ? 'text-blue-600' : 'text-gray-400'}`} />
                                <span className={`text-xs font-medium ${isExcelReady ? 'text-blue-700' : 'text-gray-400'}`}>
                                    {fileName ? fileName : (isExcelReady ? "Click para subir Excel" : "Cargando...")}
                                </span>
                            </>
                        )}
                        </div>
                        
                        {error && (
                        <div className="mt-2 text-xs text-red-600 flex items-start gap-1 bg-red-50 p-1.5 rounded">
                            <AlertCircle className="w-3 h-3 shrink-0" />
                            <span>{error}</span>
                        </div>
                        )}
                    </div>
                    
                    {/* Filtros Estilizados */}
                    {data.length > 0 && (
                        <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div className="p-3 bg-gray-50 border-b border-gray-200 flex justify-between items-center">
                            <h3 className="font-bold text-blue-900 flex items-center gap-2 text-sm">
                            <Filter className="w-4 h-4" /> Filtros
                            </h3>
                        </div>
                        
                        <div className="divide-y divide-gray-100">
                            
                            {/* Acordeón Ejercicio */}
                            <div className="bg-white">
                            <button 
                                onClick={() => toggleSection('ejercicio')}
                                className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 transition-colors"
                            >
                                <span className="text-xs font-bold text-gray-600 uppercase flex items-center gap-2">
                                    <Calendar className="w-3 h-3" /> Ejercicio
                                </span>
                                {openFilters.ejercicio ? <ChevronDown className="w-4 h-4 text-gray-400" /> : <ChevronRight className="w-4 h-4 text-gray-400" />}
                            </button>
                            
                            {openFilters.ejercicio && (
                                <div className="px-4 pb-3 animate-fadeIn">
                                    <div className="flex justify-end mb-2">
                                        <button 
                                            onClick={() => toggleAll(opcionesEjercicios, selectedEjercicios, setSelectedEjercicios)}
                                            className="text-[10px] text-blue-600 hover:underline"
                                        >
                                            {selectedEjercicios.size === opcionesEjercicios.length ? "Desmarcar todos" : "Marcar todos"}
                                        </button>
                                    </div>
                                    <div className="space-y-1 max-h-32 overflow-y-auto custom-scrollbar">
                                        {opcionesEjercicios.map(ej => (
                                            <label key={ej} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-blue-50 p-1 rounded transition-colors">
                                            <input 
                                                type="checkbox" 
                                                checked={selectedEjercicios.has(ej)}
                                                onChange={() => setSelectedEjercicios(toggleFilter(selectedEjercicios, ej))}
                                                className="rounded text-blue-600 focus:ring-blue-500 w-3 h-3 border-gray-300"
                                            />
                                            <span className="text-gray-700 text-xs">{ej}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            )}
                            </div>

                            {/* Acordeón Estado */}
                            <div className="bg-white">
                            <button 
                                onClick={() => toggleSection('estado')}
                                className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 transition-colors"
                            >
                                <span className="text-xs font-bold text-gray-600 uppercase flex items-center gap-2">
                                    <MapPin className="w-3 h-3" /> Estado
                                </span>
                                {openFilters.estado ? <ChevronDown className="w-4 h-4 text-gray-400" /> : <ChevronRight className="w-4 h-4 text-gray-400" />}
                            </button>
                            
                            {openFilters.estado && (
                                <div className="px-4 pb-3 animate-fadeIn">
                                    <div className="flex justify-end mb-2">
                                        <button 
                                            onClick={() => toggleAll(opcionesEstados, selectedEstados, setSelectedEstados)}
                                            className="text-[10px] text-blue-600 hover:underline"
                                        >
                                            {selectedEstados.size === opcionesEstados.length ? "Desmarcar todos" : "Marcar todos"}
                                        </button>
                                    </div>
                                    <div className="space-y-1 max-h-40 overflow-y-auto custom-scrollbar">
                                        {opcionesEstados.map(estado => (
                                            <label key={estado} className="flex items-center gap-2 text-sm cursor-pointer hover:bg-blue-50 p-1 rounded transition-colors">
                                            <input 
                                                type="checkbox" 
                                                checked={selectedEstados.has(estado)}
                                                onChange={() => setSelectedEstados(toggleFilter(selectedEstados, estado))}
                                                className="rounded text-blue-600 focus:ring-blue-500 w-3 h-3 border-gray-300"
                                            />
                                            <span className="text-gray-700 text-xs truncate">{estado}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                            )}
                            </div>

                            {/* Acordeón Fecha Pago (Agrupado por Año) */}
                            <div className="bg-white">
                            <button 
                                onClick={() => toggleSection('fecha')}
                                className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-gray-50 transition-colors"
                            >
                                <span className="text-xs font-bold text-gray-600 uppercase flex items-center gap-2">
                                    <Calendar className="w-3 h-3" /> Fecha Pago
                                </span>
                                {openFilters.fecha ? <ChevronDown className="w-4 h-4 text-gray-400" /> : <ChevronRight className="w-4 h-4 text-gray-400" />}
                            </button>
                            
                            {openFilters.fecha && (
                                <div className="px-4 pb-3 animate-fadeIn">
                                    <div className="flex justify-end mb-2">
                                        <button 
                                            onClick={() => toggleAll(todasLasFechasFlat, selectedFechas, setSelectedFechas)}
                                            className="text-[10px] text-blue-600 hover:underline"
                                        >
                                            {selectedFechas.size === todasLasFechasFlat.length ? "Desmarcar todos" : "Marcar todos"}
                                        </button>
                                    </div>
                                    <div className="space-y-2 max-h-60 overflow-y-auto custom-scrollbar">
                                        {aniosOrdenados.map(anio => (
                                            <div key={anio} className="border border-gray-100 rounded-md overflow-hidden">
                                                {/* Cabecera del Año */}
                                                <div className="flex items-center bg-gray-50 px-2 py-1.5 gap-2">
                                                    <button 
                                                        onClick={() => toggleYearExpand(anio)}
                                                        className="p-0.5 hover:bg-gray-200 rounded transition-colors"
                                                    >
                                                        {expandedYears.has(anio) 
                                                            ? <ChevronDown className="w-3 h-3 text-gray-500" /> 
                                                            : <ChevronRight className="w-3 h-3 text-gray-500" />}
                                                    </button>
                                                    
                                                    <button 
                                                        onClick={() => toggleYearSelection(anio)}
                                                        className="flex items-center gap-2 flex-1 text-left"
                                                    >
                                                        <CheckIcon state={getYearCheckboxState(anio)} />
                                                        <span className="text-xs font-semibold text-gray-700">{anio}</span>
                                                        <span className="text-[10px] text-gray-400 ml-auto">({fechasJerarquia[anio].length})</span>
                                                    </button>
                                                </div>

                                                {/* Lista de Fechas (Solo si expandido) */}
                                                {expandedYears.has(anio) && (
                                                    <div className="pl-8 pr-2 py-1 space-y-0.5 bg-white border-t border-gray-100">
                                                        {fechasJerarquia[anio].map(fecha => (
                                                            <label key={fecha} className="flex items-center gap-2 cursor-pointer hover:bg-blue-50 p-1 rounded transition-colors">
                                                                <input 
                                                                    type="checkbox" 
                                                                    checked={selectedFechas.has(fecha)}
                                                                    onChange={() => setSelectedFechas(toggleFilter(selectedFechas, fecha))}
                                                                    className="rounded text-blue-600 focus:ring-blue-500 w-3 h-3 border-gray-300"
                                                                />
                                                                <span className="text-xs text-gray-600">{fecha}</span>
                                                            </label>
                                                        ))}
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            )}
                            </div>

                        </div>
                        </div>
                    )}
                    </div>

                    {/* Results Area */}
                    <div className="lg:col-span-3 space-y-6">
                    
                    {/* PDF Export Section */}
                    {data.length > 0 && (
                        <div className="bg-white p-4 rounded-lg shadow-sm border border-gray-200 flex flex-col md:flex-row gap-4 items-end md:items-center justify-between">
                            <div className="w-full md:w-2/3">
                                <label className="block text-xs font-bold text-gray-500 uppercase mb-1">
                                    Nota para el Encabezado (Opcional)
                                </label>
                                <textarea 
                                    rows="2"
                                    className="w-full p-2 text-sm border border-gray-300 rounded focus:ring-2 focus:ring-blue-200 focus:border-blue-500 outline-none resize-none"
                                    placeholder="Ej: Reporte final del ciclo 2024..."
                                    value={customHeaderText}
                                    onChange={(e) => setCustomHeaderText(e.target.value)}
                                />
                            </div>
                            <button 
                                onClick={generatePDF}
                                disabled={!isPdfReady}
                                className={`flex items-center gap-2 px-6 py-3 rounded-lg font-bold shadow-sm transition-all whitespace-nowrap text-white
                                    ${isPdfReady 
                                        ? 'bg-[#1e3a8a] hover:bg-[#172554] hover:shadow-md' 
                                        : 'bg-gray-300 cursor-not-allowed'}`}
                            >
                                <FileDown className="w-5 h-5" />
                                {isPdfReady ? 'Descargar PDF' : 'Iniciando...'}
                            </button>
                        </div>
                    )}

                    {/* KPI Cards */}
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="bg-white p-4 rounded-lg border-l-4 border-blue-800 shadow-sm">
                        <div className="flex items-center gap-2 text-gray-500 mb-1">
                            <Hash className="w-4 h-4" />
                            <span className="text-xs font-bold uppercase">Total Eventos</span>
                        </div>
                        <p className="text-2xl font-bold text-gray-800">{totales.conteo}</p>
                        </div>
                        <div className="bg-white p-4 rounded-lg border-l-4 border-blue-600 shadow-sm">
                        <div className="flex items-center gap-2 text-gray-500 mb-1">
                            <Calculator className="w-4 h-4" />
                            <span className="text-xs font-bold uppercase">Total Unidades</span>
                        </div>
                        <p className="text-2xl font-bold text-gray-800">{new Intl.NumberFormat('es-MX').format(totales.unidades)}</p>
                        </div>
                        <div className="bg-white p-4 rounded-lg border-l-4 border-blue-500 shadow-sm">
                        <div className="flex items-center gap-2 text-gray-500 mb-1">
                            <DollarSign className="w-4 h-4" />
                            <span className="text-xs font-bold uppercase">Total Indemnizado</span>
                        </div>
                        <p className="text-2xl font-bold text-gray-800">{formatCurrency(totales.monto)}</p>
                        </div>
                    </div>

                    {/* Data Table */}
                    <div className="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
                        <div className="p-4 border-b border-gray-200 flex justify-between items-center bg-gray-50">
                        <h2 className="font-bold text-blue-900">Desglose por Tipo de Seguro</h2>
                        {data.length > 0 && (
                            <div className="text-xs text-gray-500 flex gap-2">
                                <span className="bg-white px-2 py-1 rounded border">
                                {selectedEstados.size === 1 
                                    ? `Estado: ${Array.from(selectedEstados)[0]}` 
                                    : selectedEstados.size === opcionesEstados.length 
                                        ? 'Todos los Estados' 
                                        : `${selectedEstados.size} Estados`}
                                </span>
                                <span className="bg-white px-2 py-1 rounded border">
                                Mostrando {reporteAgrupado.length} tipos
                                </span>
                            </div>
                        )}
                        </div>
                        
                        {data.length === 0 ? (
                        <div className="p-12 text-center text-gray-400">
                            <FileText className="w-12 h-12 mx-auto mb-3 opacity-20" />
                            <p>Sube tu archivo Excel (.xlsx) o CSV para ver el reporte.</p>
                        </div>
                        ) : (
                        <div className="overflow-x-auto">
                            <table className="w-full text-sm text-left">
                            <thead className="bg-gray-50 text-blue-900 font-semibold border-b">
                                <tr>
                                <th className="py-3 px-4">Tipo de Seguro</th>
                                <th className="py-3 px-4 text-center">Frecuencia</th>
                                <th className="py-3 px-4 text-right">Unidades Indemnizadas</th>
                                <th className="py-3 px-4 text-right">Monto Indemnizado</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-100">
                                {reporteAgrupado.map((row, idx) => (
                                <tr key={idx} className="hover:bg-blue-50 transition-colors">
                                    <td className="py-3 px-4 font-medium text-gray-800">{row.nombre}</td>
                                    <td className="py-3 px-4 text-center">
                                    <span className="bg-gray-100 text-gray-600 py-1 px-2 rounded-full text-xs font-bold">
                                        {row.conteo}
                                    </span>
                                    </td>
                                    <td className="py-3 px-4 text-right font-mono text-blue-700">
                                    {new Intl.NumberFormat('es-MX').format(row.totalUnidades)}
                                    </td>
                                    <td className="py-3 px-4 text-right font-mono font-bold text-blue-800">
                                    {formatCurrency(row.totalMonto)}
                                    </td>
                                </tr>
                                ))}
                                {/* Footer Row */}
                                <tr className="bg-gray-50 font-bold border-t-2 border-gray-200">
                                <td className="py-3 px-4 text-gray-800">TOTALES</td>
                                <td className="py-3 px-4 text-center">{totales.conteo}</td>
                                <td className="py-3 px-4 text-right text-blue-800">{new Intl.NumberFormat('es-MX').format(totales.unidades)}</td>
                                <td className="py-3 px-4 text-right text-blue-700">{formatCurrency(totales.monto)}</td>
                                </tr>
                            </tbody>
                            </table>
                        </div>
                        )}
                    </div>
                    {data.length > 0 && (
                        <div className="text-right mt-2">
                        <p className="text-xs text-gray-400 italic">
                            * Datos procesados en el navegador.
                        </p>
                        </div>
                    )}
                    </div>
                </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
